# DHCP Server Configuration for OpenShift {{ cluster_name }} PXE Boot
# Generated by ocpack

# Global DHCP settings
default-lease-time 600;
max-lease-time 7200;
authoritative;

# PXE Boot settings
allow booting;
allow bootp;

# Network configuration
{% set network_parts = cluster.network.machine_network.split('/') %}
{% set network_base = network_parts[0].split('.') %}
{% set prefix_length = network_parts[1] | int %}

subnet {{ network_parts[0] | regex_replace('\.\d+$', '.0') }} netmask {% if prefix_length == 24 %}255.255.255.0{% elif prefix_length == 16 %}255.255.0.0{% elif prefix_length == 8 %}255.0.0.0{% else %}255.255.255.0{% endif %} {
    # Network range (excluding reserved IPs)
    range {{ network_base[0] }}.{{ network_base[1] }}.{{ network_base[2] }}.100 {{ network_base[0] }}.{{ network_base[1] }}.{{ network_base[2] }}.200;
    
    # Network settings
    option routers {{ network_base[0] }}.{{ network_base[1] }}.{{ network_base[2] }}.1;
    option domain-name-servers {{ bastion_ip }};
    option domain-name "{{ cluster_id }}.{{ cluster_domain }}";
    
    # PXE Boot settings
    next-server {{ bastion_ip }};
    filename "pxelinux.0";
    
    # Boot server settings
    option tftp-server-name "{{ bastion_ip }}";
}

# Host-specific reservations based on MAC addresses
{% for cp in cluster.control_plane %}
host {{ cp.name }} {
    hardware ethernet {{ cp.mac }};
    fixed-address {{ cp.ip }};
    option host-name "{{ cp.name }}";
    # PXE boot for this host
    next-server {{ bastion_ip }};
    filename "pxelinux.0";
}
{% endfor %}

{% for worker in cluster.worker %}
host {{ worker.name }} {
    hardware ethernet {{ worker.mac }};
    fixed-address {{ worker.ip }};
    option host-name "{{ worker.name }}";
    # PXE boot for this host
    next-server {{ bastion_ip }};
    filename "pxelinux.0";
}
{% endfor %}

# Logging
log-facility local7; 